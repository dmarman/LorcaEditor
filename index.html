<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Lorca | Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css" />
    <link rel="stylesheet" href="./css/medium-editor.min.css">
    <link rel="stylesheet" href="./css/demo.css">
    <link rel="stylesheet" href="./css/beagle.min.css" id="medium-editor-theme">
    <link href="https://fonts.googleapis.com/css?family=Merriweather:300,400" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet">
</head>
<body>
    <!--<button id="correct-button">Correct</button>-->
    <header>
        <div class="navbar">
            <h1 class="app-logo">Lorca <span class="sub-logo">| Beta</span></h1>
            <div id="save-status"></div>
        </div>
    </header>
    <div class="container" id="container">
        <div class="side-column">
        </div>
        <div id="caret" class="editable"></div>
        <div id="display" class="side-column">
            <div class="column-wrapper">
                <div class="column-title">Legibilidad</div>
                <div class="meter">
                    <span id="progress-value"></span>
                </div>
                <div id="level">Muy fácil</div>
            </div>
            <div id="words">0 palabras</div>
            <div id="sentences">0 frases</div>
            <div id="time">0 segundos</div>
            <div id="adverbs"></div>
        </div>
    </div>

    <script src="./js/medium-editor.min.js"></script>
    <script src="./js/jquery.min.js"></script>
    <script src="./js/jquery.blast.min.js"></script>
    <script src="./js/lorca.js"></script>
    <script type="text/javascript" src="./js/auto-style.js"></script>

    <script>
        var timeoutId;
        var editor = new MediumEditor('.editable', {
            placeholder: {
                text: 'Escribe aquí'
            },
            extensions: {
                'auto-highlight': new AutoStyleExtension({
                    config: {
                        longWord: {
                            matchcase: false,
                            wordsonly: false,
                            class: 'long-word',
                            words: ['[a-zA-Z0-9]{14,}']
                        },
                        adverb: {
                            matchcase: false,
                            wordsonly: false,
                            class: 'adverb',
                            words: ['[a-zA-z0-9áéíóúàèìòùñç]+mente\\b']
                        },
                        veryLongSentence: {
                            matchcase: false,
                            wordsonly: false,
                            class: 'very-long-sentence',
                            words: ['[a-z A-z0-9áéíóúàèìòùñç?¿\',-]{350,}']
                        },
                        longSentence: {
                            matchcase: false,
                            wordsonly: false,
                            class: 'long-sentence',
                            words: ['[a-z A-z0-9áéíóúàèìòùñç?¿\',-]{190,}']
                        }
                    }
                })
            }
        });

        var extension = editor.getExtensionByName('auto-highlight');

        editor.subscribe('editableInput', function (event, editable) {

        });

        const lorca = new Lorca;

        editor.on($('.editable'), 'keyup', function(event){

            setTimeout(function(){
                $('#save-status').empty();
            }, 500);

            if (timeoutId) clearTimeout(timeoutId);
            timeoutId = setTimeout(function () {
                $('#save-status').text('Guardado');
            }, 1200);

            if(event.keyCode == 32){
                //console.log("space");
            }
            let plainText = lorca.clean(editor.getContent()).statistics().analysis();
//            let lastWords = plainText.content.sentences[plainText.content.sentences.length - 1].words;
//
//            if(lastWords.length > 2){
//                var str = plainText.content.sentences[plainText.content.sentences.length - 1].value.replace(/\.|nbsp/gi,'').replace(/\s+/gi,' ');
//                console.log(str);
//                extension.setConfigSection('run-' + str, {
//                    matchcase: false,
//                    wordsonly: false,
//                    //class: 'a-class',
//                    style: 'background-color:red;',
//                    words: [str]
//                });
//
//                extension.applyStyles();
//                //$('.editable').empty();
////                editor.pasteHTML(newText);
//            }

            $('#level').text(plainText.infz.level);
            $('#words').text(plainText.content.words.length + ' palabras');
            $('#sentences').text(plainText.content.sentences.length + ' frases');
            $('#time').text(plainText.time);
            $('#adverbs').text(plainText.content.adverbs.length + ' adverbios');

            function moveBar() {
                var currentPercentage = Math.round(100*$('#progress-value').width()/$('.meter').width());
                var target = plainText.infz.percentage;

                clearInterval(window.id);
                window.id = setInterval(frame, 50);
                function frame() {
                    if (target == currentPercentage) {
                        clearInterval(window.id);
                    } else if(target > currentPercentage) {
                        currentPercentage++;
                        $('#progress-value').css('width', currentPercentage + '%');
                    } else {
                        currentPercentage--;
                        $('#progress-value').css('width', currentPercentage + '%');
                    }

                    if(currentPercentage < 25) {
                        $('#progress-value').css('background-color', 'red');
                    } else if (currentPercentage > 19 && currentPercentage < 38) {
                        $('#progress-value').css('background-color', 'orange');
                    } else {
                        $('#progress-value').css('background-color', 'rgb(43,194,83)');
                    }
                }
            }
            moveBar();

        });

//        document.getElementById('correct-button').addEventListener('click', function(){
//            let sentences = $(".editable").blast({
//                delimiter: "sentence",
//            });
//            let words = $(".editable").blast({
//                delimiter: "word",
//                generateValueClass: true,
//            });
//
//            $(".editable").blast(false);
//        });

    </script>
</body>
</html>
